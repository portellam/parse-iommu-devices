#!/bin/false

#
# params
#
  if [[ -z "${1}" ]]; then
    exit 1
  fi

  declare -gr XML_FILE="${1}.xml"

  declare -agr XML_KEYS_A=(
    "devices"
  )

  declare -Agr XML_KEYS_B=(
    [${XML_KEYS_A[0]}]="hardware"
  )

  declare -Agr XML_KEYS_C=(
    [${XML_KEYS_B[${XML_KEYS_A[0]}]}]="@id,driver"
  )

#
# logic
#
  function get_bus_id_from_hardware_id
  {
    if [[ -z "${1}" ]]; then
      return 1
    fi

    local -r hardware_id="${1}"

    if [[ -z "${2}" ]]; then
      return 1
    fi

    local -n reference="${2}"

    local -r bus_id="$( \
      lspci -n \
        | grep "${hardware_id}" \
        | awk 'END {print $1}' \
    )"

    if [[ -z "${bus_id}" ]]; then
      return 1
    fi

    reference="${bus_id}"
    return 0
  }

  function get_driver_at_index_from_hardware_id
  {
    if [[ -z "${1}" ]]; then
      return 1
    fi

    local -r hardware_id="${1}"

    if [[ -z "${2}" ]]; then
      return 1
    fi

    local -n reference="${2}"

    local -i index=1

    if [[ ! -z "${3}" ]]; then
      index="${3}"
    fi

    if [[ "${index}" -lt 1 ]] \
      || ! [[ "${index}" =~ ^[0-9]+$ ]]; then
      return 1
    fi

    local -r key_a="${XML_KEYS_A[0]}"
    local -r key_b="${XML_KEYS_B[${key_a}]}"
    local -r key_c="${XML_KEYS_C[${key_b}]}"
    local key_c_list=()
    get_newline_list_from_comma_list "${key_c}" "key_c_list"

    IFS=$'\n'

    key_c_list="$( \
      echo -e "${key_c_list}" \
        | grep -i "^[@]"
    )"

    unset IFS

    local -r key_b_attribute_a="$( \
      echo -e "${key_c_list}" \
        | grep -i "^[@]" \
        | head --lines 1
    )"

    local -r driver="$(
      xmlstarlet sel -t --value-of \
        "/xml/${key_a}/${key_b}[${key_b_attribute_a}=\"${hardware_id}\"]/driver" \
        "${XML_FILE}" \
          | tail +${index} \
          | head --lines 1
    )"

    if [[ -z "${driver}" ]]; then
      return 1
    fi

    reference="${driver}"
  }

  function get_driver_from_hardware_id
  {
    if [[ -z "${1}" ]]; then
      return 1
    fi

    local -r hardware_id="${1}"

    if [[ -z "${2}" ]]; then
      return 1
    fi

    local -n reference="${2}"

    if [[ -z "${hardware_id}" ]]; then
      return 1
    fi

    local bus_id=""

    get_bus_id_from_hardware_id \
      "${hardware_id}" \
      "${bus_id}"

    local -r driver="$( \
      lspci -nnks "${bus_id}" \
        | grep driver \
        | awk 'END {print $5}'
    )"

    if [[ -z "${driver}" ]]; then
      local -ir driver_index="${3}"

      driver="$( \
        get_driver_at_index_from_hardware_id \
          "${hardware_id}" "${driver_index}"
      )"
    fi

    if [[ -z "${driver}" ]]; then
      return 1
    fi

    reference="${driver}"
    return 0
  }