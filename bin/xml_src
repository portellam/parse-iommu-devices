#!/bin/false

#
# Filename:       xml_src
# Author(s):      Alex Portell <github.com/portellam>
# Maintainer(s):  Alex Portell <github.com/portellam>
#

#
# params (1/2)
#
  if [[ -z "${1}" ]]; then
    exit 1
  fi

  declare -g SOURCE_PATH="${1}"

#
# sources (1/2)
#
  source \
    "${SOURCE_PATH}datatype_src" \
    "${SOURCE_PATH}"

#
# params (2/2)
#
  if is_empty_string "${2}"; then
    exit 1
  fi

  declare -g XML_FILE="${2}"
  declare -g KEY_A="devices"
  declare -g KEY_B="hardware"
  declare -g KEY_C="driver"
  declare -g ATTRIBUTE="@id"

#
# logic
#
  function append_xml_hardware_id
  {
    if is_empty_string "${1}"; then
      return 1
    fi

    local -r key_c_attribute="${1}"

    if is_empty_string "${2}"; then
      return 1
    fi

    local -r value_c="${2}"

    xmlstarlet edit \
      --subnode "/${KEY_A}" \
        --type --nl "/${KEY_B}" \
          --value "" \
          --insert "/${KEY_A}/${KEY_B}[last()]" \
        --type --nl "${KEY_C}" \
          --value "${key_c_attribute}" \
          --append "/${KEY_A}/${KEY_B}[last()]" \
            --insert "${ATTRIBUTE}" \
            --value "${value_c}" \
      "${XML_FILE}"
  }

  function unset_xml_hardware_id
  {
    if is_empty_string "${1}"; then
      return 1
    fi

    local -r key_c_attribute="${1}"

    xmlstarlet edit \
      --delete "/${KEY_A}/${KEY_B}[${ATTRIBUTE}=\"${key_c_attribute}\"]" \
      "${XML_FILE}"
  }

  function unset_xml_driver
  {
    if is_empty_string "${1}"; then
      return 1
    fi

    local -r key_c_attribute="${1}"

    if is_empty_string "${2}"; then
      return 1
    fi

    local -r value_c="${2}"

    xmlstarlet edit \
      --delete "/${KEY_A}/${KEY_B}[${ATTRIBUTE}='${key_c_attribute}']/${KEY_C}" \
          --value "${value_c}" --nl \
      "${XML_FILE}"
  }

  function set_xml_hardware_id_list
  {
    if ! is_boolean "${1}"; then
      return 1
    fi

    local do_delete_any_unused_hardware_id="${1}"
    shift

    if [[ -z "${1}" ]]; then
      return 1
    fi

    local -ar hardware_id_list=( "${@}" )

    for hardware_id in $( get_xml_hardware_id_list ); do
      if [[ "${hardware_id_list[*]}" =~ "${hardware_id}" ]]; then
        continue
      fi

      if "${do_delete_any_unused_hardware_id}" \
        && ! append_xml_hardware_id "${hardware_id}"; then
        return 1
      fi
    done

    local -a xml_hardware_id_list="$( get_xml_hardware_id_list )"

    for hardware_id in ${hardware_id_list[@]}; do
      if ! [[ "${xml_hardware_id_list[*]}" =~ "${hardware_id}" ]]; then
        continue
      fi

      if ! unset_xml_hardware_id "${hardware_id}"; then
        return 1
      fi
    done

    return 0
  }

  function set_xml_driver_list
  {
    if is_empty_string "${1}"; then
      return 1
    fi

    local hardware_id="${1}"
    shift
    local -ar driver_list="${@}"

    for driver in $( get_xml_driver_list "${hardware_id}" ); do
      if [[ "${driver_list[*]}" =~ "${driver}" ]]; then
        continue
      fi

      if ! insert_xml_driver "${driver}"; then
        return 1
      fi
    done

    local -a xml_driver_list="$( get_xml_driver_list "${hardware_id}" )"

    for driver in ${driver_list[@]}; do
      if ! [[ "${xml_driver_list[*]}" =~ "${driver}" ]]; then
        continue
      fi

      if ! unset_xml_driver "${driver}"; then
        return 1
      fi
    done

    return 0
  }

  function get_xml_hardware_id_list
  {
    xmlstarlet select \
      --template \
        --match "//${KEY_A}/${KEY_B}" \
        --match "${ATTRIBUTE}" \
          --value-of "." --nl \
      "${XML_FILE}"
  }

  function get_xml_driver_list
  {
    if is_empty_string "${1}"; then
      return 1
    fi

    local -r key_c_attribute="${1}"

    xmlstarlet select \
      --template \
        --match "/${KEY_B} [${ATTRIBUTE}=\"${key_c_attribute}\"]" \
        --match "/${KEY_C}" \
          --value-of "." --nl \
      "${XML_FILE}"
  }

  function get_xml_driver
  {
    if ! is_positive_integer "${2}"; then
      return 1
    fi

    local -i index="${2}"
    local -i count=0

    for driver in $( get_xml_driver_list "${1}" ); do
      if [[ "${count}" -eq "${index}" ]]; then
        break
      fi

      (( index++ ))
    done

    echo "${driver}"
  }

  function insert_xml_driver
  {
    if is_empty_string "${1}"; then
      return 1
    fi

    local -r key_c_attribute="${1}"

    if is_empty_string "${2}"; then
      return 1
    fi

    local -r value_c="${2}"

    xmlstarlet edit \
      --update "/${KEY_A}/${KEY_B}[${ATTRIBUTE}=\"${key_c_attribute}\"]" \
        --insert @version \
          --value "${value_c}" --nl \
      "${XML_FILE}"
  }

  function update_xml_driver
  {
    if is_empty_string "${1}"; then
      return 1
    fi

    local -r key_c_attribute="${1}"

    if is_empty_string "${2}"; then
      return 1
    fi

    local -r value_c="${2}"

    xmlstarlet edit \
      --update "/${KEY_A}/${KEY_B}[${ATTRIBUTE}=\"${key_c_attribute}\"]/${KEY_C}" \
          --value "${value_c}" --nl \
      "${XML_FILE}"
  }

  function write_xml_template_to_file
  {
    echo -e \
      "<?xml version=\"1.0\"?>\n" \
      "<devices>\n" \
      "</devices>" \
      > "${1}"
  }
