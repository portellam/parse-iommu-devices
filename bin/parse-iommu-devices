#!/bin/bash

#
# Filename:       parse-iommu-devices
# Description:    Bash script to parse, sort, and display hardware devices by
#                 selected IOMMU group, and return the device drivers and
#                 hardware IDs as output.
# Author(s):      Alex Portell <github.com/portellam>
# Maintainer(s):  Alex Portell <github.com/portellam>
# Version:        1.0.2
#

#
# TODO:
# - [ ] add validation for all inputs.
# - [x] fix output to show every IOMMU group and it's device info.
# - [x] fix lists?
# - [ ] check if all commands used are installed.
# - [x] ignore groups with vfio.
# - [ ] xml file
#   - hardware ID as primary key.
#   - record one or more driver(s).
#   - if `lspci` differs and is not binded to vfio, update or append.
#   - append new information.
#   - add functionality to sort by driver name?
#  - use this script inside deploy-VFIO.
# - [ ] create logger.
#

#
# TESTS:
# - [x] all operators
#   - fix comma delimited lists for each match operator (works for first value).
# - [ ] test with vfio setup.
#

#
# sources
#
  source ./datatype_src
  source ./print_src
  source ./parse_src "$( basename "${0}" )" "1.0.2"

  function main
  {
    set_tabspace_size
    create_logfile
    log "${0} ${@}"
    parse_arguments "${@}"

    if ! verify_groups; then
      return 1
    fi

    local -r message="Parsing hardware devices..."

    local -a group_output=()
    print_and_log_output "${message}"

    if ! parse_many_groups; then
      print_and_log_output "${message} Failed."
      return 1
    fi

    print_and_log_output "${message} Successful.\n"
    print_groups_output
  }

main "$@"