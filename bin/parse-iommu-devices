#!/bin/bash

#
# Filename:       parse-iommu-devices
# Description:    Parse, sort, and display hardware devices by IOMMU group.
# Author(s):      Alex Portell <github.com/portellam>
# Maintainer(s):  Alex Portell <github.com/portellam>
# Version:        1.0.0
#

shopt -s nullglob

declare -r SCRIPT_VERSION="1.0.0"
declare -r SCRIPT_NAME="$( basename "${0}" )"

declare -A ARGUMENTS=(
  ["GET_MINIMUM_OUTPUT"]=false
  ["MATCH_EXTERNALS"]=true
  ["MATCH_GROUPS"]=false
  ["MATCH_INTERNALS"]=true
  ["MATCH_NAMES"]=false
  ["MATCH_VGA_GROUP_INDEX"]=false
  ["REVERSE_MATCH_NAMES"]=false
  ["GROUPS_TO_MATCH"]=""
  ["NAMES_TO_MATCH"]=""
  ["NAMES_TO_REVERSE_MATCH"]=""
  ["VGA_GROUP_INDEX_TO_MATCH"]=""
)

declare -A OUTPUTS=(
  ["FOUND_GROUPS"]=""
  ["FOUND_DRIVERS"]=""
  ["FOUND_HW_IDS"]=""
)

function parse_arguments
{
  while [[ ! -z "${1}" ]]; do
    # parse_nested_arguments "${1}"   # TODO: FIX ME!

    case "${1,,}" in
      "-e" | "--external" )
          ARGUMENTS["MATCH_EXTERNALS"]=true
          ARGUMENTS["MATCH_INTERNALS"]=false
        ;;

      "-g" | "--group" )
          ARGUMENTS["MATCH_GROUPS"]=true
          shift
          parse_invalid_option "${1}"
          ARGUMENTS["GROUPS_TO_MATCH"]="${1}"
        ;;

      "-output" | "--get-output" )
          ARGUMENTS["GET_MINIMUM_OUTPUT"]=true
        ;;

      "-v" | "--vga-index" )
          ARGUMENTS["MATCH_VGA_GROUP_INDEX"]=true
          shift
          parse_invalid_option "${1}"

          if ! $( \
            echo "${1}" \
              | grep --extended-regexp --quiet '^[0-9]+(,[0-9]+)*$'
            ) || [[ "${1}" -lt 1 ]]; then

            if "${ARGUMENTS["GET_MINIMUM_OUTPUT"]}"; then
              exit 1
            fi

            echo -e "Error: Invalid input or index specified."
            echo "Please enter a value of '1' or greater."
            exit 1
          fi

          ARGUMENTS["VGA_GROUP_INDEX_TO_MATCH"]="${1}"
        ;;

      "-n" | "--name" )
          ARGUMENTS["MATCH_NAMES"]=true
          shift
          parse_invalid_option "${1}"
          ARGUMENTS["NAMES_TO_MATCH"]="${1}"
        ;;

      "--reverse-name" )
          ARGUMENTS["REVERSE_MATCH_NAMES"]=false

          shift
          parse_invalid_option "${1}"
          ARGUMENTS["NAMES_TO_REVERSE_MATCH"]="${1}"
        ;;

      "" )
        return 0
        ;;

      "-h" | "--help" )
        print_usage
        exit 0
        ;;

      * )
        print_invalid_argument
        ;;

    esac

    shift
  done
}

function parse_invalid_option
{
  if [[ "${1}" != "-"* ]]; then
    return 0
  fi

  if ! "${ARGUMENTS["GET_MINIMUM_OUTPUT"]}"; then
    echo -e "Error: Invalid option specified."
  fi

  exit 1
}

function parse_nested_arguments   # TODO: FIX ME!
{
  if [[ -z "${1}" ]]; then
    return 0
  fi

  if ! $( \
    echo "${1}" \
      | grep --extended-regexp --quiet '^(-[Aa-Zz])*$'
  ) && [[ "${1}" != "--"* ]]; then
    print_invalid_argument
  fi

  for argument in ${1::1}; do
    argument="-${argument}"
    echo "Hello World"
    parse_arguments "${argument}"
  done
}

function print_invalid_argument
{
  if "${ARGUMENTS["GET_MINIMUM_OUTPUT"]}"; then
    exit 1
  fi

  echo -e "Error: Invalid argument(s) specified."

  print_usage
  exit 1
}

function print_usage
{
  if "${ARGUMENTS["GET_MINIMUM_OUTPUT"]}"; then
    return 0
  fi

  echo -e "Usage:\t${SCRIPT_NAME} [ARGUMENTS]..."
  echo -e "Parse, sort, and display hardware devices by IOMMU group."
  echo -e "Version ${SCRIPT_VERSION}."
  echo
  echo -e "  -h, --help  Print this help and exit."
  echo

  echo -e "  -o, --get-output          Quiet all output except for comma " \
    " lists of device drivers and hardware IDs."

  echo -e "  -e, --external            Match IOMMU groups without only internal" \
    "devices."

  echo -e "  -g, --group [OPTION]      Match IOMMU group ID(s)." \
    "Comma delimited."

  echo -e "  -n, --name [OPTION]       Match IOMMU group(s) with device name." \
    "Comma delimited."

  echo -e "  --reverse-name [OPTION]   Match IOMMU group(s) without device" \
    "name. Comma delimited."

  echo -e "  -v, --vga-index [OPTION]  Match all IOMMU groups without VGA, and" \
    "any with VGA which match the index value(s) (starting from 1 and not an" \
    "IOMMU group ID). Comma delimited."

  echo
  echo -e "Examples:"

  echo -e "  ${SCRIPT_NAME} -e -v 1    Show only IOMMU groups with external" \
  "devices, and exclude IOMMU groups with VGA device(s) after the first match."

  echo

  echo -e "  ${SCRIPT_NAME} -n     Show only IOMMU groups with external" \
  "devices, and exclude IOMMU groups with VGA device(s) after the first match."
}

function show_groups
{
  vga_group_index=0

  for group in $( \
    find /sys/kernel/iommu_groups/* -maxdepth 0 -type d \
    | sort --version-sort
  ); do
    group_id="${group##*/}"

    if ! "${ARGUMENTS["GET_MINIMUM_OUTPUT"]}"; then
      echo "IOMMU Group ${group_id}:"
    fi

    if "${ARGUMENTS["MATCH_GROUPS"]}" \
      && ! $( \
        echo ",${ARGUMENTS["GROUPS_TO_MATCH"]}," \
          | grep --quiet ",${group_id},"
      ); then
      continue
    fi

    group_id_list=""
    driver_list=""
    hardware_id_list=""
    has_name=false
    has_reverse_name=false
    has_vga=false

    for device in ${group##}/devices/*; do
      name="$( lspci -s ${device##*/} )"
      name="${name:8}"

      bus_id="$( \
        lspci -ns ${device##*/} \
          | awk 'END {print $1}'
      )"

      hardware_id="$( \
        lspci -ns ${device##*/} \
          | awk 'END {print $3}'
      )"

      driver="$( \
        lspci -kns ${device##*/} \
          | grep "driver" \
          | awk 'END {print $5}'
      )"

      if ! "${ARGUMENTS["MATCH_EXTERNALS"]}" \
        && [[ "${bus_id::2}" != "00" ]]; then
        continue
      fi

      if ! "${ARGUMENTS["MATCH_INTERNALS"]}" \
        && [[ "${bus_id::2}" == "00" ]]; then
        continue
      fi

      if "${has_reverse_name}" \
        && "${ARGUMENTS["REVERSE_MATCH_NAMES"]}"; then
        for this_name in $( \
            echo "${ARGUMENTS["NAMES_TO_REVERSE_MATCH"]}" \
              | sed "s/,/ /g"
        ); do
          if $( \
            echo "${name,,}" \
              | grep --invert-match --quiet "${this_name,,}"
          ); then
            has_reverse_name=true
            continue
          fi
        done
      fi

      if ! "${has_name}" \
        && "${ARGUMENTS["MATCH_NAMES"]}"; then
        for this_name in $( \
            echo "${ARGUMENTS["NAMES_TO_MATCH"]}" \
              | sed "s/,/ /g"
        ); do
          if $( \
            echo "${name,,}" \
              | grep --quiet "${this_name,,}"
          ); then
            has_name=true
            continue
          fi
        done
      fi

      if $( \
        echo "${name,,}" \
          | grep --quiet "vga"
      ); then
        has_vga=true
      fi

      if "${ARGUMENTS["REVERSE_MATCH_NAMES"]}" \
        && ! "${has_reverse_name}"; then
        continue
      fi

      if "${ARGUMENTS["MATCH_NAMES"]}" \
        && ! "${has_name}"; then
        continue
      fi

      if ! "${ARGUMENTS["GET_MINIMUM_OUTPUT"]}"; then
        echo -e "\tBus ID:\t${bus_id}"
        echo -e "\t\tName:\t\t${name}"
        echo -e "\t\tHardware ID:\t${hardware_id}"
        echo -e "\t\tDriver:\t\t${driver}"
        echo
      fi

      if [[ ",${group_id_list,,}," != *",${group_id},"* ]]; then
        group_id_list+="${group_id},"
      fi

      if [[ ",${driver_list,,}," != *",${driver},"* ]]; then
        driver_list+="${driver},"
      fi

      if [[ ",${hardware_id_list,,}," != *",${hardware_id},"* ]]; then
        hardware_id_list+="${hardware_id},"
      fi
    done

    if "${has_vga}"; then
      (( vga_group_index++ ))
    fi

    if "${ARGUMENTS["MATCH_VGA_GROUP_INDEX"]}" \
      && "${has_vga}" \
      && [[ ",${ARGUMENTS["VGA_GROUP_INDEX_TO_MATCH"],,}," \
        != *",${vga_group_index},"* ]]; then
      group_id_list=""
      driver_list=""
      hardware_id_list=""
    fi

    OUTPUTS["FOUND_GROUPS"]+="${group_id_list}"
    OUTPUTS["FOUND_DRIVERS"]+="${driver_list}"
    OUTPUTS["FOUND_HW_IDS"]+="${hardware_id_list}"

    if ! "${ARGUMENTS["GET_MINIMUM_OUTPUT"]}"; then
      echo
    fi
  done

  if [[ ! -z "${OUTPUTS["FOUND_GROUPS"]}" ]]; then
    OUTPUTS["FOUND_GROUPS"]="${OUTPUTS["FOUND_GROUPS"]::-1}"
  fi

  if [[ ! -z "${OUTPUTS["FOUND_DRIVERS"]}" ]]; then
    OUTPUTS["FOUND_DRIVERS"]="${OUTPUTS["FOUND_DRIVERS"]::-1}"

    OUTPUTS["FOUND_DRIVERS"]="$( \
      echo "${OUTPUTS["FOUND_DRIVERS"]}" \
        | sed --expression $'s/,/\\\n/g' \
        | sort --numeric-sort \
        | tr '\n' ',' \
        | sed 's/.$//' \
        | tr ',' '\n' \
        | sort --unique \
        | xargs \
        | tr ' ' ','
    )"
  fi

  if [[ ! -z "${OUTPUTS["FOUND_HW_IDS"]}" ]]; then
    OUTPUTS["FOUND_HW_IDS"]="${OUTPUTS["FOUND_HW_IDS"]::-1}"

    OUTPUTS["FOUND_HW_IDS"]="$( \
      echo "${OUTPUTS["FOUND_HW_IDS"]}" \
        | sed --expression $'s/,/\\\n/g' \
        | sort --numeric-sort \
        | tr '\n' ',' \
        | sed 's/.$//' \
        | tr ',' '\n' \
        | sort --unique \
        | xargs \
        | tr ' ' ','
    )"
  fi
}

function output_info
{
  if ! "${ARGUMENTS["GET_MINIMUM_OUTPUT"]}"; then
    echo -e "Groups:\t\t${OUTPUTS["FOUND_GROUPS"]}"
    echo -e "Drivers:\t${OUTPUTS["FOUND_DRIVERS"]}"
    echo -e "Hardware IDs:\t${OUTPUTS["FOUND_HW_IDS"]}"
    return 0
  fi

  echo "${OUTPUTS["FOUND_DRIVERS"]}"
  echo "${OUTPUTS["FOUND_HW_IDS"]}"
}

function main
{
  parse_arguments "${@}" || return 1
  show_groups
  output_info
}

main "$@"